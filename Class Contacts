public with sharing class Contacts {
    
    public static List<Contact> createMembers(String firstName, String lastName) {
        List<Contact> members = new List<Contact>();
        List<String> lastNames = new List<String>(getFamilies(lastName));
        List<Account> accs = [SELECT Id FROM Account WHERE Name IN :lastNames]; 
       
        List<String> firstNames = new List<String>(getFirstName(firstName));
        List<Account> existingName = [SELECT Id FROM Account WHERE Name IN :firstNames];        
        
        if(accs.isEmpty()) {
         accs = new List<Account>();
          for (String ln : lastNames) {
           Account newAcc = new Account(Name = ln);
            accs.add(newAcc);
  }     
         insert accs;
} 
        else if(lastNames.size() != accs.size()) {
         List<String> existingNames = new List<String>();
          for (Account acc : accs) {
           existingNames.add(acc.Name);
}
        accs = new List<Account>();
         for (String ln : lastNames) {
          if (!existingNames.contains(ln)) {
           Account newAcc = new Account(Name = ln);
            accs.add(newAcc);
   }
}      
        insert accs; 
        accs.addAll(accs);
// Verifica se todas as famílias foram adicionadas à variável accs
// Se alguma família não estiver presente, retorna uma lista vazia para indicar que a criação de membros não foi bem sucedida        
         for (String ln : lastNames) {
         if (!existingNames.contains(ln)) {
         return new List<Contact>();
     }
   }        
 }      
        if(existingName.isEmpty()) {
         existingName = new List<Account>();
          for (String fn : firstNames) {
           Account newFirstName = new Account(Name = fn);
            existingName.add(newFirstName);
   }
        insert existingName; 
} 
         for(Account acc : accs) {
            members.add(new Contact(FirstName = firstName, LastName = lastName, AccountId = acc.Id));
        }
       return members;
}
    private static List<String> getFamilies(String lastName) {
        List<String> families = new List<String>();
        List<String> lastNames = lastName.split(' ');
        Integer lastNamesQuantity = lastNames.size();
        
        for (Integer i = 0; i < lastNamesQuantity; i++) {
         families.addAll(buildLastNames(lastNames, lastNamesQuantity, i));
       }
        return families;
}   
    private static List<String> getFirstName (String firstName) {
        List<String> existingNames = new List<String>();
        List<String> ListfirstName = firstName.split(' ');
        Integer firstNamesQuantity = ListfirstName.size();
        
        for (Integer i = 0; i < firstNamesQuantity; i++) {
         List<Contact> contacts = [SELECT Id FROM Contact WHERE FirstName = :ListfirstName[i]];
          if (!contacts.isEmpty()) {
           existingNames.add(ListfirstName[i]);
     }
  }
        return existingNames;
} 
    public static List<String> buildLastNames(List<String> lastNames, Integer lastNamesQuantity, Integer startingIndex) {
        List<String> lastNameTemp = new List<String>();
        String currentLastName = '';
        
        for (Integer j = startingIndex; j < lastNamesQuantity; j++) {
         if (j > startingIndex) {
          currentLastName += ' ';
 }
          currentLastName += lastNames[j];
          lastNameTemp.add(currentLastName);
        }
     return lastNameTemp;
   }
}
